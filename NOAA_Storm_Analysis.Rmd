---
title: 'NOAA Storm Database: Health and Economic Impacts'
author: "Kevin Joy"
date: "10/15/2019"
output:
  html_document:
    keep_md: yes
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Executive Summary

This project involves exploring the U.S. National Oceanic and Atmospheric Administration's (NOAA) storm database. This database tracks characteristics of major storms and weather events in the United States, including when and where they occur, as well as estimates of any fatalities, injuries, and property damage.  

The data analysis addresses the following questions:

1. Across the United States, which types of events (as indicated in the **EVTYPE** variable) are most harmful with respect to population health?
    - The analysis will demonstrate that the following Events have the largest impact on population health  
        1. EXCESSIVE HEAT
        2. TORNADO
        3. FLASH FLOOD
        4. RIP CURRENT
        5. LIGHTNING
        6. HEAT
        7. THUNDERSTORM WIND
        8. WILDFIRE
        
2. Across the United States, which types of events have the greatest economic consequences?
    - The analysis will demonstrate that the following Events have the greatest economic consequences  
        1. FLOOD
        2. HURRICANE/TYPHOON
        3. STORM SURGE
        4. HAIL
        5. FLASH FLOOD
        6. TORNADO
        7. DROUGHT
        8. FROST/FREEZE

## Data Processing
- Load necessary packages
```{r message=FALSE}
library(tidyverse)
library(lubridate)
```

- Download data and load csv.bz2 file.
- Since the dataset is large and more recent data is more complete we will only load a subset of data to do this analysis.

```{r cache=TRUE}
data_url <- "https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2"
dataName <- "data/storm.csv.bz2"
if(!dir.exists("data")){dir.create("data")}


if(!file.exists(dataName)){
    download.file(data_url, dataName)
    #no need to unzip
  }
storm_headers <- names(read.csv(dataName, nrows = 2))
storm <- read.csv(dataName, header=FALSE, skip =500000)
names(storm) <- storm_headers
```

Following scripts will clean, filter and normalize the data  
1. Convert dates from factor to dates.  
- Assume the years 2005 - 2010 are representative for the analysis  
- Since 2011 is not a complete year remove 2011  
  
```{r}
storm$BGN_DATE <- mdy_hms(storm$BGN_DATE)
storm$END_DATE <- mdy_hms(storm$END_DATE)

#filter to only show values between 2005 and 2010
storm <- filter(storm, BGN_DATE >= "2005-01-01", BGN_DATE < "2011-01-01")
```

2. Normalize Property Damage and Crop Damage to millions by creating new variables

```{r message=FALSE}
exp_key = data.frame( key = c("K", "M", "B", "0", ""), value = c(1000, 1000000, 1000000000, 10, 0))

storm$PROPDMG_USD_M = storm %>%
  select(PROPDMGEXP, PROPDMG) %>%
  left_join(exp_key , by = c("PROPDMGEXP" = "key")) %>%
  mutate(PROPDMG_USD_M = PROPDMG * value / 1000000) %>%
  pull()

storm$CROPDMG_USD_M = storm %>%
  select(CROPDMGEXP, CROPDMG) %>%
  left_join(exp_key , by= c("CROPDMGEXP"="key")) %>%
  mutate(CROPDMG_USD_M = CROPDMG * value / 1000000) %>%
  pull()
```


## Results
- Summarize the years of data beween 2005 - 2010 for each Event Type to determine total injuries, fatalities, property damage and crop damage
```{r}
storm_impact = storm %>% 
  group_by(EVTYPE) %>% 
  summarize(inj = sum(INJURIES),
            fat = sum(FATALITIES),
            prop=sum(PROPDMG_USD_M),
            crop = sum(CROPDMG_USD_M))
storm_impact %>% arrange(desc(fat))
```

#### Types of events that are most harmful to population health:
*Event Types that are in top 90th percentiles for either Injuries or Fatalities between 2005 - 2010*
```{r}
health_impact <- storm_impact %>%
      select(EVTYPE, fat, inj) %>%
      filter(fat > quantile(fat, .9) | inj > quantile(inj, .9)) %>%
      arrange(desc(fat)) %>%
      rename("Fatalities (2005 - 2010)" = fat ,
             "Injuries (2005 - 2010)" = inj )
    health_impact
```    

##### The following figure displays the most devasting weather events for health sorted by Injuries:

```{r fig.height=4, fig.width=12}

health_impact_long <- gather(health_impact, "TYPE", "VALUE", -EVTYPE)
ggplot(health_impact_long, aes(reorder(EVTYPE, VALUE), VALUE, fill=TYPE)) +
  geom_col(position="dodge") +
  coord_flip() +
  labs(title = "Health Impact of Major Storms between 2005 - 2010",
        y = "# of Injuries / Fatialities",
        x = "Event Type"
        )
```


#### Types of events that have the greatest economic consequences:
Event Types that are in top 90th percentiles for either Property or Crop damage between 2005 - 2010  

```{r}
economic_impact <- storm_impact %>%
      select(EVTYPE, prop, crop) %>%
      filter(prop > quantile(prop, .9) | crop > quantile(crop, .9)) %>%
      arrange(desc(prop)) %>%
      rename("Propety Damage $M (2005 - 2010)" = prop ,
             "Crop Damage $M (2005 - 2010)" = crop )
    economic_impact
```    

**The following figure displays the most economically impactful weather events sorted by property damage:**

```{r fig.height=4, fig.width=12}
economic_impact_long <- gather(economic_impact, "TYPE", "VALUE", -EVTYPE)
ggplot(economic_impact_long, aes(reorder(EVTYPE, VALUE), VALUE, fill=TYPE)) +
  geom_col(position="dodge") +
  coord_flip() +
  labs(title = "Economic Impact of Major Storms between 2005 - 2010",
        y = "$M",
        x = "Event Type"
        )
```

**Better predictions of the aforementioned weather events will lead to saving lives and the livlihood of people within the United States**