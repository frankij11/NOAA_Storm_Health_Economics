---
title: 'NOAA Storm Database: Health and Economic Impacts'
author: "Kevin Joy"
date: "10/15/2019"
output: 
  html_document:
    keep_md: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Executive Summary

This project involves exploring the U.S. National Oceanic and Atmospheric Administration's (NOAA) storm database. This database tracks characteristics of major storms and weather events in the United States, including when and where they occur, as well as estimates of any fatalities, injuries, and property damage.  

The data analysis addresses the following questions:

1. Across the United States, which types of events (as indicated in the **EVTYPE** variable) are most harmful with respect to population health?
    * 

2. Across the United States, which types of events have the greatest economic consequences?


## Data Analysis:

### 1. Data Processing
- Load necessary packages
```{r message=FALSE}
library(tidyverse)
library(lubridate)
```

- Download data and load csv.bz2 file.
- Since the dataset is large and more recent data is more complete we will only load a subset of data to do this analysis.
```{r cache=TRUE}
data_url <- "https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2"
dataName <- "data/storm.csv.bz2"
if(!dir.exists("data")){dir.create("data")}


if(!file.exists(dataName)){
    download.file(data_url, dataName)
    #no need to unzip
  }
storm_headers <- names(read.csv(dataName, nrows = 2))
storm <- read.csv(dataName, header=FALSE, skip =500000)
names(storm) <- storm_headers
```

- Following script will clean the data
  1. Convert dates from factor to dates. 
    * Assume the years 2005 - 2010 are representative for the analysis
    * Since 2011 is not a complete year remove 2011
  
```{r cache=TRUE}
storm$BGN_DATE <- mdy_hms(storm$BGN_DATE)
storm$END_DATE <- mdy_hms(storm$END_DATE)

#filter to only show values greater than 2000
storm <- filter(storm, BGN_DATE >= "2005-01-01", BGN_DATE < "2011-01-01")
```

  2. Normalize Property Damage and Crop Damage to millions by creating new variables
```{r message=FALSE}
exp_key = data.frame( key = c("K", "M", "B", "0", ""), value = c(1000, 1000000, 1000000000, 10, 0))

storm$PROPDMG_USD_M = storm %>%
  select(PROPDMGEXP, PROPDMG) %>%
  left_join(exp_key , by = c("PROPDMGEXP" = "key")) %>%
  mutate(PROPDMG_USD_M = PROPDMG * value / 1000000) %>%
  pull()

storm$CROPDMG_USD_M = storm %>%
  select(CROPDMGEXP, CROPDMG) %>%
  left_join(exp_key , by= c("CROPDMGEXP"="key")) %>%
  mutate(CROPDMG_USD_M = CROPDMG * value / 1000000) %>%
  pull()


```


### 2. Results
- Summarize the years of data beween 2005 - 2010 to determine total injuries fatalities, property damage and crop damage
```{r}
storm_impact = storm %>% 
  group_by(EVTYPE) %>% 
  summarize(inj = sum(INJURIES),
            fat = sum(FATALITIES),
            prop=sum(PROPDMG_USD_M),
            crop = sum(CROPDMG_USD_M))
```

#### + Types of events that are most harmful to population health:
    - Event Types that are in the 90th percentile for causing Injuries between 2005 - 2010
    ```{r}
    other_inj_sum <- sum(storm_impact$inj) - sum(filter(storm_impact, inj > quantile(inj,.9))$inj)
    storm_impact %>%
      select(EVTYPE, inj) %>%
      filter(inj > quantile(inj, .9)) %>%
      arrange(desc(inj)) %>%
      rbind(data.frame(EVTYPE = "OTHER", inj = other_inj_sum) ) %>%      
      mutate(percentage = paste0(round(inj/ sum(inj), 2)*100, "%")) %>%
      rename("Injuries (2005 - 2010)" = inj)
    ```



    - Event Types that are in the 90th percentile for causing Fatalities between 2005 - 2010

    ```{r}
    storm_impact %>%
      select(EVTYPE, fat) %>%
      filter(fat > quantile(fat, .9)) %>%
      arrange(desc(fat)) %>%
      rename("Fatalities (2005 - 2010)" = fat)
             
    ```
    - Event Types that are in top 90th percentiles for both Injuries and Fatalities between 2005 - 2010
    ```{r}
    storm_impact %>%
      select(EVTYPE, inj, fat) %>%
      filter(fat > quantile(fat, .9), inj > quantile(inj, .9)) %>%
      arrange(desc(fat)) %>%
      rename("Fatalities (2005 - 2010)" = fat ,
             "Injuries (2005 - 2010)" = inj )
      
    ```    
    
    - Event Types that are in top 90th percentiles for either Injuries or Fatalities between 2005 - 2010
    ```{r}
    storm_impact %>%
      select(EVTYPE, fat, inj) %>%
      filter(fat > quantile(fat, .9) | inj > quantile(inj, .9)) %>%
      arrange(desc(fat)) %>%
      rename("Fatalities (2005 - 2010)" = fat ,
             "Injuries (2005 - 2010)" = inj )
      
    ```    


```{r}
ggplot(top_health_impact[order(top_health_impact$inj, decreasing = TRUE),]) + geom_col( aes(x= reorder(EVTYPE, inj), inj)) + geom_col( aes(EVTYPE, fat), color = "red", position = "dodge") + coord_flip()
```

#### + Types of events that have the greatest economic consequences:
    


